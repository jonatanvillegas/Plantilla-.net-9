@using UI.Models
@model Productos

<div class="container-fluid mt-2">

    <input type="hidden" id="productoId" value="@(Model?.Id ?? 0)" />

    <div class="row justify-content-center">
        <div class="col-xxl-10">
            <div class="row">
                <div class="col-xxl-8">

                    <!-- INFORMACIÓN DEL PRODUCTO -->
                    <div class="card">
                        <div class="card-header d-block p-3">
                            <h4 class="card-title mb-1">Información del Producto</h4>
                        </div>

                        <div class="card-body">
                            <div class="row">

                                <div class="col-12 mb-3">
                                    <label class="form-label">Nombre del producto <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nombre"
                                           placeholder="Ingrese el nombre del producto"
                                           value="@(Model?.Nombre ?? "")">
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Código <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="codigo"
                                           placeholder="Ej: SOFA-10058"
                                           value="@(Model?.Codigo ?? "")">
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Stock <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="stock"
                                           placeholder="Cantidad en inventario"
                                           value="@(Model?.Stock ?? 0)">
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Estado <span class="text-danger">*</span></label>
                                    <select class="form-select" id="estado" required></select>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- IMAGEN DEL PRODUCTO -->
                    <div class="card mt-3">
                        <div class="card-header p-3">
                            <h4 class="card-title mb-1">Imagen del producto</h4>
                            <p class="text-muted mb-0">Subir imagen del producto.</p>
                        </div>

                        <div class="card-body">
                            <div class="dropzone-previews mt-3" id="file-previews"></div>
                        </div>
                    </div>

                </div>

                <!-- COLUMNA DERECHA (4 columnas) -->
                <div class="col-xxl-4">

                    <!-- PRECIO -->
                    <div class="card">
                        <div class="card-header p-3">
                            <h4 class="card-title mb-1">Precio</h4>
                            <p class="text-muted mb-0">Establezca el precio del producto.</p>
                        </div>

                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Precio Base <span class="text-danger">*</span></label>

                                <div class="app-search">
                                    <input type="number" step="0.01" class="form-control" id="precio"
                                           placeholder="Ej: 199.99"
                                           value="@(Model?.Precio.ToString("N2") ?? "")">
                                    <i data-lucide="dollar-sign" class="app-search-icon text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ACCIONES -->
                    <div class="card card-top-sticky mt-3">
                        <div class="card-body">
                            <h4>Acciones</h4>
                            <hr />

                            <div class="d-flex flex-column gap-2">

                                <button type="button" id="btnGuardar"
                                        class="btn btn-outline-light btn-Editar">
                                    <i class="ti ti-user me-1"></i> Guardar cambios
                                </button>

                                <a href="javascript:history.back()" class="btn btn-secondary">
                                    <i class="ti ti-arrow-back me-1"></i> Volver
                                </a>

                            </div>
                        </div>
                    </div>

                </div> <!-- Fin columna derecha -->

            </div>
        </div>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@section Scripts {
    <script>
        $(document).ready(function () {

            let estadoSeleccionado = @Model?.EstadoId ?? 0;

            // CARGAR ESTADOS
            $.get('@Url.Action("ObtenerEstados", "Productos", new { area = "Producto" })', function (data) {

                let select = $("#estado");
                select.empty();
                select.append('<option value="">Seleccione...</option>');

                data.forEach(function (item) {
                    let selected = item.id === estadoSeleccionado ? "selected" : "";
                    select.append(`<option value="${item.id}" ${selected}>${item.nombre}</option>`);
                });

            }); 

            $("#btnGuardar").click(function () {

                // 1. Obtener datos
                const nombre = $("#nombre").val().trim();
                const codigo = $("#codigo").val().trim();
                const stock = $("#stock").val().trim();
                const precio = $("#precio").val().trim();
                const estadoId = $("#estado").val();

                if (nombre === "" || codigo === "" || stock === "" || precio === "" || estadoId === "") {

                    Swal.fire({
                        icon: 'warning',
                        title: 'Campos incompletos',
                        text: 'Por favor complete todos los campos.',
                        confirmButtonText: 'Entendido'
                    });

                    return;
                }

                if (isNaN(stock) || isNaN(precio) || parseInt(stock) < 0 || parseFloat(precio) < 0) {

                    Swal.fire({
                        icon: 'error',
                        title: 'Datos inválidos',
                        text: 'Stock y Precio deben ser números válidos.',
                        confirmButtonText: 'Aceptar'
                    });

                    return;
                }
                const data = {
                    Id: parseInt($("#productoId").val()) || 0,
                    Nombre: nombre,
                    Codigo: codigo,
                    Stock: parseInt(stock),
                    Precio: parseFloat(precio),
                    EstadoId: parseInt(estadoId)
                };

                $.ajax({
                    url: '@Url.Action("GuardarProducto", "Productos", new { area = "Producto" })',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function (resp) {

                        Swal.fire({
                            icon: 'success',
                            title: 'Guardado correctamente',
                            text: resp.mensaje,
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            window.location.href = "/Producto/Productos/ListadoProductos";
                        });
                    },
                    error: function (xhr) {

                        let mensajeError = "Error desconocido";

                        if (xhr.responseJSON && xhr.responseJSON.mensaje)
                            mensajeError = xhr.responseJSON.mensaje;
                        else
                            mensajeError = xhr.responseText;

                        Swal.fire({
                            icon: 'error',
                            title: 'Error al guardar',
                            text: mensajeError,
                            confirmButtonText: 'Cerrar'
                        });
                    }
                });

            }); 

        });
    </script>
}

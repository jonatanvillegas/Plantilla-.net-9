@using UI.Models
@model Productos

@section Styles{
    <link href="~/plugins/dropzone/dropzone.css" rel="stylesheet" />
}
<div class="container-fluid mt-2">
    <div class="row justify-content-center">
        <div class="col-xxl-10">
            <div class="row">
                <div class="col-xxl-8">

                    <!-- INFORMACIÓN DEL PRODUCTO -->
                    <div class="card">
                        <div class="card-header d-block p-3">
                            <h4 class="card-title mb-1">Información del Producto</h4>
                        </div>

                        <div class="card-body">
                            <div class="row">

                                <div class="col-12 mb-3">
                                    <label class="form-label">Nombre del producto <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nombre"
                                           placeholder="Ingrese el nombre del producto"
                                           value="@(Model?.Nombre ?? "")">
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Código <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="codigo"
                                           placeholder="Ej: SOFA-10058"
                                           value="@(Model?.Codigo ?? "")">
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Stock <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="stock"
                                           placeholder="Cantidad en inventario"
                                           value="@(Model?.Stock ?? 0)">
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <label class="form-label">Estado <span class="text-danger">*</span></label>
                                    <select class="form-select" id="estado" required></select>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- IMAGEN DEL PRODUCTO -->
                    <div class="card shadow-sm mt-3">
                        <div class="card-body">
                            <h6 class="card-title mb-3">Imagen del Producto</h6>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Seleccionar Imagen</label>

                                <!-- Dropzone -->
                                <div id="productoDropzone" class="dropzone border rounded p-3 text-center">
                                    <div class="dz-message">
                                        Arrastra la imagen aquí o haz clic para seleccionar (1 imagen)
                                    </div>
                                </div>
                            </div>

                            <!-- Vista Previa -->
                            <div class="text-center mt-3">
                                <img id="previewImagen"
                                     src="#"
                                     style="max-width: 180px;
                        max-height: 180px;
                        display: none;
                        border: 2px solid #e0e0e0;
                        padding: 6px;
                        border-radius: 10px;
                        object-fit: cover;
                        background: #fafafa;">
                            </div>

                            <input type="hidden" id="productoId" value="@(Model?.Id ?? 0)" />
                        </div>
                    </div>
                </div>

                <!-- COLUMNA DERECHA (4 columnas) -->
                <div class="col-xxl-4">

                    <!-- PRECIO -->
                    <div class="card">
                        <div class="card-header p-3">
                            <h4 class="card-title mb-1">Precio</h4>
                            <p class="text-muted mb-0">Establezca el precio del producto.</p>
                        </div>

                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Precio Base <span class="text-danger">*</span></label>

                                <div class="app-search">
                                    <input type="number" step="0.01" class="form-control" id="precio"
                                           placeholder="Ej: 199.99"
                                           value="@(Model?.Precio.ToString("N2") ?? "")">
                                    <i data-lucide="dollar-sign" class="app-search-icon text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ACCIONES -->
                    <div class="card card-top-sticky mt-3">
                        <div class="card-body">
                            <h4>Acciones</h4>
                            <hr />

                            <div class="d-flex flex-column gap-2">

                                <button type="button" id="btnGuardar"
                                        class="btn btn-outline-light btn-Editar">
                                    <i class="ti ti-user me-1"></i> Guardar cambios
                                </button>

                                <a href="javascript:history.back()" class="btn btn-secondary">
                                    <i class="ti ti-arrow-back me-1"></i> Volver
                                </a>

                            </div>
                        </div>
                    </div>

                </div> <!-- Fin columna derecha -->

            </div>
        </div>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@section Scripts {
    <script src="~/plugins/dropzone/dropzone-min.js"></script>
    <script>
        $(document).ready(function () {

            let estadoSeleccionado = @(Model?.EstadoId ?? 0);
            console.log("JS cargado correctamente");

            // CARGAR ESTADOS (se mantiene igual)
            $.get('@Url.Action("ObtenerEstados", "Productos", new { area = "Producto" })', function (data) {
                let select = $("#estado");
                console.log("Estados recibidos:", data);

                select.empty();
                select.append('<option value="">Seleccione...</option>');
                data.forEach(function (item) {
                    let selected = item.id === estadoSeleccionado ? "selected" : "";
                    select.append(`<option value="${item.id}" ${selected}>${item.nombre}</option>`);
                });
            });

            // Inicializar Dropzone (no autoProcesar)
            Dropzone.autoDiscover = false;
            const myDropzone = new Dropzone("#productoDropzone", {
                url: "#", // no se usa porque usamos AJAX personalizado
                autoProcessQueue: false,
                maxFiles: 1,
                acceptedFiles: "image/*",
                addRemoveLinks: true,
                dictRemoveFile: "Eliminar",
                init: function () {
                    var dz = this;

                    // Si ya hay una imagen en BD, inyectarla como mock file
                    var existingUrl = '@(ViewBag.ExistingImageUrl ?? "")';
                    var existingName = '@(ViewBag.ExistingImageName ?? "")';
                    var existingSize = @(ViewBag.ExistingImageSize ?? 0);

                    if (existingUrl) {
                        var mockFile = { name: existingName || "imagen.jpg", size: existingSize || 12345 };
                        dz.emit("addedfile", mockFile);
                        dz.emit("thumbnail", mockFile, existingUrl);
                        dz.emit("complete", mockFile);
                        dz.files.push(mockFile);

                        // mostrar vista previa adicional si existe el img#previewImagen
                        $("#previewImagen").attr("src", existingUrl).show();
                    }

                    dz.on("addedfile", function (file) {
                        // Si ya había un archivo, eliminar el anterior (sólo 1 imagen)
                        if (dz.files.length > 1) {
                            dz.removeFile(dz.files[0]);
                        }

                        // Vista previa con FileReader (actual)
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            $("#previewImagen").attr("src", e.target.result).show();
                        };
                        reader.readAsDataURL(file);
                    });

                    dz.on("removedfile", function (file) {
                        $("#previewImagen").hide().attr("src", "#");
                    });
                }
            });

                    $("#btnGuardar").click(function () {

            // ================= VALIDACIONES =================
            const nombre = $("#nombre").val().trim();
            const codigo = $("#codigo").val().trim();
            const stock = $("#stock").val().trim();
            const precio = $("#precio").val().trim();
            const estadoId = $("#estado").val();

            if (nombre === "" || codigo === "" || stock === "" || precio === "" || estadoId === "") {
                Swal.fire({
                    icon: 'warning',
                    title: 'Campos incompletos',
                    text: 'Por favor complete todos los campos.',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            if (isNaN(stock) || isNaN(precio) || parseInt(stock) < 0 || parseFloat(precio) < 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Datos inválidos',
                    text: 'Stock y Precio deben ser números válidos.',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // ================= CONFIRMACIÓN =================
            Swal.fire({
                title: '¿Guardar producto?',
                text: 'Se guardarán los cambios del producto.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, guardar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {

                if (!result.isConfirmed) return;

                // ================= FORM DATA =================
                const formData = new FormData();
                formData.append('Id', parseInt($("#productoId").val()) || 0);
                formData.append('Nombre', nombre);
                formData.append('Codigo', codigo);
                formData.append('Stock', parseInt(stock));
                formData.append('Precio', parseFloat(precio));
                formData.append('EstadoId', parseInt(estadoId));

                const archivos = myDropzone.getAcceptedFiles();
                if (archivos.length > 0) {
                    formData.append('imagenFile', archivos[0], archivos[0].name);
                }

                // ================= LOADING =================
                Swal.fire({
                    title: 'Guardando...',
                    text: 'Por favor espere',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // ================= AJAX =================
                $.ajax({
                    url: '@Url.Action("GuardarProducto", "Productos", new { area = "Producto" })',
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (resp) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Guardado correctamente',
                            text: resp.mensaje || 'El producto se guardó con éxito',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            window.location.href = '@Url.Action("ListadoProductos", "Productos", new { area = "Producto" })';
                        });
                    },
                    error: function (xhr) {
                        let mensajeError = "Error desconocido";

                        if (xhr.responseJSON?.mensaje)
                            mensajeError = xhr.responseJSON.mensaje;
                        else if (xhr.responseText)
                            mensajeError = xhr.responseText;

                        Swal.fire({
                            icon: 'error',
                            title: 'Error al guardar',
                            text: mensajeError,
                            confirmButtonText: 'Cerrar'
                        });
                    }
                });

            });
        });


        });
    </script>

}